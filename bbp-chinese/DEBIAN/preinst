#!/bin/bash
set -e

# 密码输入函数（显示星号，带实时反馈）
input_password_with_echo() {
  local password=''
  local prompt="请输入安装密码（加群873338741获取）: "
  
  # 确保提示信息立即显示
  echo -n "$prompt" > /dev/tty

  # 保存终端设置
  stty_save=$(stty -g)
  # 禁用回显
  stty -echo -icanon < /dev/tty

  # 逐字符读取
  while IFS= read -r -n1 char; do
    # 处理回车（确认输入）
    if [[ -z $char ]]; then
      break
    fi
    # 处理退格/删除
    if [[ $char == $'\177' || $char == $'\b' ]]; then
      if [ -n "$password" ]; then
        password=${password%?}
        # 删除终端显示的最后一个星号
        printf "\b \b" > /dev/tty
      fi
    else
      password+="$char"
      # 显示星号反馈
      printf "*" > /dev/tty
    fi
  done

  # 恢复终端设置
  stty $stty_save < /dev/tty
  echo > /dev/tty  # 换行
  echo "$password"
}

# 明确提示用户开始输入
echo "即将进行密码验证..." > /dev/tty

# 获取密码
PASSWORD=$(input_password_with_echo)

# 验证密码
if [ "$PASSWORD" != "{APASSWORDHERE}" ]; then
  echo -e "\n错误：密码不正确！" > /dev/tty
  exit 1
fi

#!/bin/sh
set -e

# 加载 debconf 函数库
. /usr/share/debconf/confmodule

# 初始化 debconf 系统
db_version 2.0
db_capb backup

# 设置模板参数
db_settitle bbp-chinese/install-path

# 交互式提问
db_input medium bbp-chinese/install-path || true
db_go

# 获取用户输入
db_get bbp-chinese/install-path
INSTALL_PATH="$RET"

# 路径标准化处理
CLEAN_PATH=$(echo "$INSTALL_PATH" | \
  sed -e 's/\\ / /g' \       # 处理转义空格
     -e 's/[“”]/"/g' \       # 替换中文引号
     -e 's/／/\//g')         # 替换全角斜杠

# 文件存在性验证
validate_install_path() {
  if [ ! -f "${CLEAN_PATH}/BALDI.x86_64" ] && [ ! -f "${CLEAN_PATH}/BALDI.x86" ]; then
    db_subst bbp-chinese/install-path ERROR_INFO "检测到路径：$CLEAN_PATH"
    db_input critical bbp-chinese/invalid-path || true
    db_go
    exit 1
  fi
}

validate_install_path

# 存储配置
echo "ACTUAL_INSTALL_PATH='$CLEAN_PATH'" > /tmp/bbp-chinese.conf
chmod 600 /tmp/bbp-chinese.conf
