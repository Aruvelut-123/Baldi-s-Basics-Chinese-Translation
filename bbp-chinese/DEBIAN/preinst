#!/bin/bash
set -e

# 密码输入函数（显示星号，带实时反馈）
input_password_with_echo() {
  local password=''
  local prompt="请输入安装密码（加群873338741获取）: "
  
  # 确保提示信息立即显示
  echo -n "$prompt" > /dev/tty

  # 保存终端设置
  stty_save=$(stty -g)
  # 禁用回显
  stty -echo -icanon < /dev/tty

  # 逐字符读取
  while IFS= read -r -n1 char; do
    # 处理回车（确认输入）
    if [[ -z $char ]]; then
      break
    fi
    # 处理退格/删除
    if [[ $char == $'\177' || $char == $'\b' ]]; then
      if [ -n "$password" ]; then
        password=${password%?}
        # 删除终端显示的最后一个星号
        printf "\b \b" > /dev/tty
      fi
    else
      password+="$char"
      # 显示星号反馈
      printf "*" > /dev/tty
    fi
  done

  # 恢复终端设置
  stty $stty_save < /dev/tty
  echo > /dev/tty  # 换行
  echo "$password"
}

# 加载 debconf 函数库（兼容非交互环境）
if [ -f /usr/share/debconf/confmodule ]; then
    . /usr/share/debconf/confmodule
fi

# 初始化 debconf 系统（仅交互模式）
init_debconf() {
    db_version 2.0
    db_capb backup
    db_settitle bbp-chinese/install-path
}

# 安全获取安装路径
get_install_path() {
    # 非交互模式处理
    if [ ! -t 0 ] || [ "$DEBIAN_FRONTEND" = "noninteractive" ]; then
        # 从环境变量或默认路径获取
        INSTALL_PATH="${INSTALL_PATH:-/default/path}"
        return 0
    fi

    # 交互模式使用 debconf
    init_debconf
    db_input medium bbp-chinese/install-path || true
    db_go
    db_get bbp-chinese/install-path
    INSTALL_PATH="$RET"
}

# 路径标准化处理
sanitize_path() {
    echo "$1" | sed \
        -e 's/\\ / /g' \     # 处理转义空格
        -e 's/[“”]/"/g' \    # 替换中文引号
        -e 's/／/\//g' \     # 替换全角斜杠
        -e 's/^ *//;s/ *$//' # 去除首尾空格
}

# 增强文件验证
validate_files() {
    local path="$1"
    local found=0

    # 检查可执行文件
    for exe in BALDI.x86_64 BALDI.x86; do
        if [ -f "${path}/${exe}" ] && [ -x "${path}/${exe}" ]; then
            found=1
            break
        fi
    done

    # 错误处理
    if [ $found -eq 0 ]; then
        if [ -t 0 ]; then
            echo "错误：未找到可执行文件" > /dev/tty
            echo "路径内容：" > /dev/tty
            ls -l "$path" > /dev/tty
        fi
        exit 1
    fi
}

# 主执行流程
main() {
    # 明确提示用户开始输入
    echo "即将进行密码验证..." > /dev/tty

    # 获取密码
    PASSWORD=$(input_password_with_echo)

    # 验证密码
    if [ "$PASSWORD" != "{APASSWORDHERE}" ]; then
      echo -e "\n错误：密码不正确！" > /dev/tty
      exit 1
    fi
    
    get_install_path
    CLEAN_PATH=$(sanitize_path "$INSTALL_PATH")
    validate_files "$CLEAN_PATH"

    # 安全存储配置
    mkdir -p /tmp/bbp-chinese
    printf "ACTUAL_INSTALL_PATH=%q\n" "$CLEAN_PATH" > /tmp/bbp-chinese/config
    chmod 600 /tmp/bbp-chinese/config
}

main