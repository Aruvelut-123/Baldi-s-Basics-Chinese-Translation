#!/bin/bash
set -e

# 密码输入函数（显示星号，带实时反馈）
input_password_with_echo() {
  local password=''
  local prompt="请输入安装密码（加群873338741获取）: "
  
  # 确保提示信息立即显示
  echo -n "$prompt" > /dev/tty

  # 保存终端设置
  stty_save=$(stty -g)
  # 禁用回显
  stty -echo -icanon < /dev/tty

  # 逐字符读取
  while IFS= read -r -n1 char; do
    # 处理回车（确认输入）
    if [[ -z $char ]]; then
      break
    fi
    # 处理退格/删除
    if [[ $char == $'\177' || $char == $'\b' ]]; then
      if [ -n "$password" ]; then
        password=${password%?}
        # 删除终端显示的最后一个星号
        printf "\b \b" > /dev/tty
      fi
    else
      password+="$char"
      # 显示星号反馈
      printf "*" > /dev/tty
    fi
  done

  # 恢复终端设置
  stty $stty_save < /dev/tty
  echo > /dev/tty  # 换行
  echo "$password"
}

# 明确提示用户开始输入
echo "即将进行密码验证..." > /dev/tty

# 获取密码
PASSWORD=$(input_password_with_echo)

# 验证密码
if [ "$PASSWORD" != "{APASSWORDHERE}" ]; then
  echo -e "\n错误：密码不正确！" > /dev/tty
  exit 1
fi

# 正确获取安装路径 (使用db_get)
db_get bbp-chinese/install-path || true
INSTALL_PATH="$RET"
[ -z "$INSTALL_PATH" ] && INSTALL_PATH="$DEFAULT_INSTALL_PATH"

# 处理路径中的空格和特殊字符
INSTALL_PATH=$(echo "$INSTALL_PATH" | sed 's/\\ / /g')  # 转换反斜杠转义空格
INSTALL_PATH=$(realpath -m "$INSTALL_PATH" 2>/dev/null || printf "%s" "$INSTALL_PATH")

# 文件校验逻辑
if [ ! -f "${INSTALL_PATH}/BALDI.x86_64" ] && [ ! -f "${INSTALL_PATH}/BALDI.x86" ]; then
  echo -e "\n错误：未找到游戏主程序！" > /dev/tty
  echo "需要以下文件之一：" > /dev/tty
  echo "  - BALDI.x86_64 (64位版本)" > /dev/tty
  echo "  - BALDI.x86 (32位版本)" > /dev/tty
  echo "当前路径内容：" > /dev/tty
  ls -1 "$INSTALL_PATH" 2>/dev/null || echo "（目录不存在或无法访问）" > /dev/tty
  exit 1
fi

# 将路径存储到临时文件供postinst使用
echo "ACTUAL_INSTALL_PATH=$INSTALL_PATH" > /tmp/bbp-chinese.conf
