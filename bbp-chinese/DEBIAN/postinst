#!/bin/bash
set -e

# 从临时文件读取路径
source /tmp/bbp-chinese.conf
rm -f /tmp/bbp-chinese.conf

# 检查7z依赖
if ! command -v 7z >/dev/null; then
  apt-get update && apt-get install -y p7zip-full
fi

# 解压文件
7z x /opt/bbp-chinese/BBP.7z -o"$ACTUAL_INSTALL_PATH" -y
7z x /opt/bbp-chinese/BepInEx.7z -o"$ACTUAL_INSTALL_PATH" -y
7z x /opt/bbp-chinese/AutoTranslator.7z -o"$ACTUAL_INSTALL_PATH" -y

# 处理可选组件
if [ "$(debconf-get bbp-chinese/moddingapi)" = "true" ]; then
  7z x /opt/bbp-chinese/BBDevAPI.7z -o"$ACTUAL_INSTALL_PATH" -y
fi
if [ "$(debconf-get bbp-chinese/bbtimes)" = "true" ]; then
  7z x /opt/bbp-chinese/BBTimes.7z -o"$ACTUAL_INSTALL_PATH" -y
fi

chmod u+x $ACTUAL_INSTALL_PATH/run_bepinex.sh

# 记录安装路径到配置文件
mkdir -p /etc/bbp-chinese
echo "INSTALL_PATH=$ACTUAL_INSTALL_PATH" > /etc/bbp-chinese/config

# 图标安装
cp /opt/bbp-chinese/icon.ico /usr/share/icons/bbp-chinese.ico

echo "安装完毕，请运行run_bepinex.sh来启动游戏"
echo "如果你想使用Steam来运行，请设置启动选项为./run_bepinex.sh %command%"