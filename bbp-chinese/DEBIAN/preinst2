#!/bin/bash
set -e

# 正确获取安装路径 (使用db_get)
db_get bbp-chinese/install-path || true
INSTALL_PATH="$RET"
[ -z "$INSTALL_PATH" ] && INSTALL_PATH="$DEFAULT_INSTALL_PATH"

# 处理路径中的空格和特殊字符
INSTALL_PATH=$(echo "$INSTALL_PATH" | sed 's/\\ / /g')  # 转换反斜杠转义空格
INSTALL_PATH=$(realpath -m "$INSTALL_PATH" 2>/dev/null || printf "%s" "$INSTALL_PATH")

# 文件校验逻辑
if [ ! -f "${INSTALL_PATH}/BALDI.x86_64" ] && [ ! -f "${INSTALL_PATH}/BALDI.x86" ]; then
  echo -e "\n错误：未找到游戏主程序！" > /dev/tty
  echo "需要以下文件之一：" > /dev/tty
  echo "  - BALDI.x86_64 (64位版本)" > /dev/tty
  echo "  - BALDI.x86 (32位版本)" > /dev/tty
  echo "当前路径内容：" > /dev/tty
  ls -1 "$INSTALL_PATH" 2>/dev/null || echo "（目录不存在或无法访问）" > /dev/tty
  exit 1
fi

# 将路径存储到临时文件供postinst使用
echo "ACTUAL_INSTALL_PATH=$INSTALL_PATH" > /tmp/bbp-chinese.conf
