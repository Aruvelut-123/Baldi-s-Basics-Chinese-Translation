#!/bin/sh
set -e

# 加载 debconf 函数库
. /usr/share/debconf/confmodule

# 初始化 debconf 系统
db_version 2.0
db_capb backup

# 设置模板参数
db_settitle bbp-chinese/install-path

# 交互式提问
db_input medium bbp-chinese/install-path || true
db_go

# 获取用户输入
db_get bbp-chinese/install-path
INSTALL_PATH="$RET"

# 路径标准化处理
CLEAN_PATH=$(echo "$INSTALL_PATH" | \
  sed -e 's/\\ / /g' \       # 处理转义空格
     -e 's/[“”]/"/g' \       # 替换中文引号
     -e 's/／/\//g')         # 替换全角斜杠

# 文件存在性验证
validate_install_path() {
  if [ ! -f "${CLEAN_PATH}/BALDI.x86_64" ] && [ ! -f "${CLEAN_PATH}/BALDI.x86" ]; then
    db_subst bbp-chinese/install-path ERROR_INFO "检测到路径：$CLEAN_PATH"
    db_input critical bbp-chinese/invalid-path || true
    db_go
    exit 1
  fi
}

validate_install_path

# 存储配置
echo "ACTUAL_INSTALL_PATH='$CLEAN_PATH'" > /tmp/bbp-chinese.conf
chmod 600 /tmp/bbp-chinese.conf